# Agora Speech to Text Demo

Agora speech to text demo

## サービスを使う方法

> ソースコードの  
```ChatRoomViewController.swift```, 109行目から参照する (on 2023.01.02)

```Swift
@IBAction private func onSTTButtonClicked(_ sender: UIButton) {
    ...
}
```

## サービスを起動・停止するAPI

> APIのコードが ```STTApi.swift``` にある  
Documetn reference: [pre production doc of stt](https://docs-preprod.agora.io/en/live-streaming-premium-legacy/speech_to_text_rest?platform=iOS)

### トークンを請求する

STTサービスのトークンを請求する。

Method: POST  
Endpoint: {BaseURL}[^1]/v1/projects/{appId}[^2]/rtsc/speech-to-text/builderTokens

#### Response

```JSON
{
    "tokenName": "",
    "createTs": 0,
    "instanceId": 0
}
```

### STTタスクを起動する

チャンネルに、STTサービスを起動する。

Method: POST  
Endpoint: {BaseURL}[^1]/v1/projects/{appId}[^2]/rtsc/speech-to-text/tasks?builderTokens={tokenName}[^3]

#### Request Body

ソースファイル ```STTRequestModel.swift```　の中  
下記の関数を参照してください。

```Swift
struct AgoraSTTStartRequestModel: CommonRequestModel {
    ...
}
```

#### Response

```JSON
{
    "taskId": "",
    "createTs": 0,
    "status": 0
}
```

#### 起動中のSTTタスクを検索する

起動中のSTTタスクを検索する

Method: GET  
Endpoint: {BaseURL}[^1]/v1/projects/{appId}[^2]/rtsc/speech-to-text/tasks/{taskId}[^4]?builderTokens={tokenName}[^3]

#### STTタスクを停止する

STTタスクを停止する

Method: DELETE  
Endpoint: {BaseURL}[^1]/v1/projects/{appId}[^2]/rtsc/speech-to-text/tasks/{taskId}[^4]?builderTokens={tokenName}[^3]

## 文字を取得と表示

文字データが ```receiveStreamMessageFromUid``` というdelegate関数にアプリに送信する。  
データの書式がprotobuff、 ```pod "Protobuf"``` を使って、関連のframeworkを導入してください。  
```AgoraManager.swift```の200行目からのソースを参照してください。

```Swift
func rtcEngine(_ engine: AgoraRtcEngineKit, receiveStreamMessageFromUid uid: UInt, streamId: Int, data: Data) {
    ...
}
```

## Protobuf

字幕データがProtobufを使ってエンコードする。
下記のProtobufコードをプロジェクトに入れる必要がある。

### Protobufコード

フォルダ ```./Protobuffer/code```  で
三種類の言語のコードがある

* /csharp
* /java
* /objective-c

*Generated by protoc-21.12-osx-aarch_64*

### Generate shell script:

```
./Protobuffer/genCode.sh

## Other

---

[^1]: If you want to try, please contact huyuhua@agora.io to get base url.  
[^2]: Your agora App Id.  
[^3]: The token you got from Acquire API.  
[^4]: The task id that got from Start API.
